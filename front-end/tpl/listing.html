<div class="container product-form-container">
  <div class="card p-4 p-md-5 rounded-4 shadow-sm">
    <div class="text-center mb-5">
      <h1 class="h2 fw-bold">List a New Product</h1>
      <p class="text-muted">
        Fill out the details below to add a product to your store.
      </p>
    </div>

    <!-- Product Form -->
    <form id="productForm" novalidate>
      <!-- Product Image Upload -->
      <div class="mb-4">
        <label class="form-label fw-medium">Product Image</label>
        <div id="image-preview" class="image-upload-box">
          <div class="image-upload-content">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="48"
              height="48"
              fill="currentColor"
              class="bi bi-image text-muted mx-auto mb-3"
              viewBox="0 0 16 16"
            >
              <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
              <path
                d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12"
              />
            </svg>
            <label
              for="product_image"
              class="text-primary fw-medium"
              style="cursor: pointer"
            >
              <span>Upload an image</span>
            </label>
            <p class="text-muted small mt-1">PNG, JPG, GIF</p>
            <input
              id="product_image"
              name="product_image"
              type="file"
              class="product-file-input"
              accept="image/png, image/jpeg, image/gif"
            />
          </div>
        </div>
        <div id="image-error" class="invalid-feedback d-none">
          A product image is required.
        </div>
      </div>

      <!-- Product Name -->
      <div class="mb-3">
        <label for="name" class="form-label fw-medium">Product Name</label>
        <input
          type="text"
          id="name"
          name="name"
          required
          class="form-control form-control-lg"
          placeholder="e.g., Premium Wireless Headphones"
        />
        <div class="invalid-feedback">Product name is required.</div>
      </div>

      <!-- Product Description -->
      <div class="mb-3">
        <label for="description" class="form-label fw-medium"
          >Description</label
        >
        <textarea
          id="description"
          name="description"
          rows="4"
          class="form-control form-control-lg"
          placeholder="Describe the product, its features, and benefits..."
        ></textarea>
      </div>

      <div class="row g-3 mb-3">
        <!-- Price -->
        <div class="col-md-6">
          <label for="price" class="form-label fw-medium">Price ($)</label>
          <input
            type="number"
            id="price"
            name="price"
            required
            min="0"
            step="0.01"
            class="form-control form-control-lg"
            placeholder="e.g., 99.99"
          />
          <div class="invalid-feedback">Please enter a valid price.</div>
        </div>

        <!-- Stock Quantity -->
        <div class="col-md-6">
          <label for="stock_quantity" class="form-label fw-medium"
            >Stock Quantity</label
          >
          <input
            type="number"
            id="stock_quantity"
            name="stock_quantity"
            required
            min="0"
            step="1"
            class="form-control form-control-lg"
            placeholder="e.g., 150"
          />
          <div class="invalid-feedback">
            Please enter a valid stock quantity.
          </div>
        </div>
      </div>

      <!-- Category -->
      <div class="mb-4">
        <label for="category_id" class="form-label fw-medium">Category</label>
        <select
          id="category_id"
          name="category_id"
          required
          class="form-select form-select-lg"
        >
          <option value="" disabled selected>Select a category</option>
          <option value="1">Electronics</option>
          <option value="2">Books</option>
          <option value="3">Clothing</option>
          <option value="4">Home & Kitchen</option>
          <option value="5">Sports</option>
        </select>
        <div class="invalid-feedback">Please select a category.</div>
      </div>

      <!-- Submission Feedback -->
      <div id="form-feedback" class="alert alert-success d-none" role="alert">
        Your product has been listed successfully!
      </div>
      <div id="form-error" class="alert alert-danger d-none" role="alert">
        Please correct the errors above before submitting.
      </div>

      <!-- Submit Button -->
      <div class="d-grid">
        <button type="submit" class="btn btn-primary btn-lg">
          List Product
        </button>
      </div>
    </form>
  </div>
</div>
<script>
  /* ---------------------------------------------------
   IMAGE PREVIEW + UPLOAD
--------------------------------------------------- */

  const imageInput = document.getElementById("product_image");
  const previewBox = document.getElementById("image-preview");
  let uploadedImagePath = null; // path returned from backend

  // When image is selected
  imageInput.addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    // Show preview
    const reader = new FileReader();
    reader.onload = function (event) {
      previewBox.innerHTML = `
      <img src="${event.target.result}"
           class="img-fluid rounded"
           style="max-height: 200px; object-fit: cover;">
    `;
    };
    reader.readAsDataURL(file);

    // Upload image to backend
    const imgForm = new FormData();
    imgForm.append("image", file);

    try {
      const response = await fetch(
        "http://localhost/webShop/back-end/upload-image",
        {
          method: "POST",
          body: imgForm,
        }
      );

      const data = await response.json();
      console.log("Image uploaded:", data);

      if (data.path) {
        uploadedImagePath = data.path; // <-- SAVE PATH FOR PRODUCT FORM
      } else {
        console.error("Upload error:", data);
      }
    } catch (err) {
      console.error("Image upload failed:", err);
    }
  });

  /* ---------------------------------------------------
   JWT DECODER
--------------------------------------------------- */
  function decodeJwt(token) {
    try {
      const base64Url = token.split(".")[1];
      const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
      return JSON.parse(window.atob(base64));
    } catch (e) {
      console.error("JWT decode error:", e);
      return null;
    }
  }

  /* ---------------------------------------------------
   PRODUCT FORM SUBMIT
--------------------------------------------------- */
  document
    .getElementById("productForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target;

      // Reset messages
      document.getElementById("form-feedback").classList.add("d-none");
      document.getElementById("form-error").classList.add("d-none");

      let isValid = form.checkValidity();

      // Validate image uploaded
      if (!uploadedImagePath) {
        isValid = false;
        document.getElementById("image-error").classList.remove("d-none");
      } else {
        document.getElementById("image-error").classList.add("d-none");
      }

      if (!isValid) {
        document.getElementById("form-error").classList.remove("d-none");
        return;
      }

      // FORM IS VALID â€“ submit product
      const formData = new FormData(form);

      const user = decodeJwt(sessionStorage.getItem("auth"));
      formData.set("user_id", user.user.id);

      // IMPORTANT: ONLY SEND PATH, NOT THE FILE
      formData.set("image", uploadedImagePath);

      // Remove actual file field if exists
      formData.delete("product_image");

      try {
        const response = await fetch(
          "http://localhost/webShop/back-end/products",
          {
            method: "POST",
            headers: {
              auth: localStorage.getItem("authToken"),
            },
            body: formData,
          }
        );

        const data = await response.json();
        console.log("Product created:", data);

        document.getElementById("form-feedback").classList.remove("d-none");
        form.reset();
        previewBox.innerHTML = ""; // Clear image preview
        uploadedImagePath = null;
      } catch (err) {
        console.error("Product submit failed:", err);
        document.getElementById("form-error").classList.remove("d-none");
      }
    });
</script>
